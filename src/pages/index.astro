---
import BlogCard from '@/components/BlogCard.astro'
import ContributionChart from '@/components/ContributionChart'
import FriendsRSSFeed from '@/components/FriendsRSSFeed'
import Link from '@/components/Link.astro'
import PageHead from '@/components/PageHead.astro'
import { buttonVariants } from '@/components/ui/button'
import { SITE } from '@/consts'
import Layout from '@/layouts/Layout.astro'
import { getRecentPosts, getAllPosts, getAllAuthors } from '@/lib/data-utils'
import { getFriendRSSFeeds, getRecentFeedItems } from '@/lib/rss-utils'
import '@fontsource/lxgw-wenkai';

const blog = await getRecentPosts(SITE.featuredPostCount)
const allPosts = await getAllPosts()

const friends = await getAllAuthors()
const feedsMap = await getFriendRSSFeeds(friends)
const recentFeedItems = getRecentFeedItems(feedsMap, 3)

const friendsMap = new Map(friends.map(f => [f.id, f]))

const friendPosts = recentFeedItems.map(({ friendId, item }) => {
  const friend = friendsMap.get(friendId)
  return {
    title: item.title,
    link: item.link,
    description: item.description || '',
    pubDate: item.pubDate.toISOString(),
    friendName: friend?.data.name || 'æœªçŸ¥ä½œè€…',
    friendAvatar: friend?.data.avatar || '',
    friendWebsite: friend?.data.website || '#'
  }
})
---

<Layout class="max-w-3xl">
  <PageHead slot="head" title="Hej." />
  <section>
    <div class="rounded-lg border">
      <div class="flex flex-col space-y-1.5 p-6">
        <h3 class="text-3xl leading-none font-medium">Hejï¼Œæ—…è¡Œè€…ï¼</h3>
        <p class="text-muted-foreground text-sm">
          æ¥è‡ª Frederick Â· <span class="font-medium">[ OIer / Blogger / Student ]</span>
        </p>
        <a title="æ— èŠæ¹¾ ğŸ¥± The Boring Bay" href="https://boringbay.com"><img width="100px" src="https://boringbay.com/api/badge/blog.ohdragonboi.cn"></img></a>
      </div>
      <div class="p-6 pt-0">
        <p class="text-muted-foreground mb-2 text-sm">
          
          è¿™é‡Œæ˜¯ <Link
            href="https://github.com/fenychn0206"
            class="text-foreground"
            external
            underline>Frederick</Link
          > çš„ä¸ªäººç«™ï¼Œé‡‡ç”¨ <Link
            href="https://astro.build"
            class="text-foreground"
            external
            underline>Astro</Link
          > æ­å»ºï¼Œè¿™é‡Œæœ‰ç”Ÿæ´»è®°å½•ã€é¡¹ç›®åˆ†äº«ã€é—²èŠæ‚è°ˆï¼Œè¿˜æœ‰æ–‡ç« è½¬è½½ã€æ–‡ç« ç¿»è¯‘ã€ç§‘æŠ€èµ„è®¯ï¼Œå¸Œæœ›ä½ å¯ä»¥æ‰¾åˆ°ä½ æƒ³è¦çš„å†…å®¹ï¼
        </p>
        <p class="text-muted-foreground text-sm">
          åšä¸»ç›®å‰ä»äº‹äºä¿¡æ¯å­¦ç«èµ›ï¼Œä¹Ÿæ´»è·ƒäºå¼€æºç¤¾åŒºã€‚ä¸è¿‡æ–‡ç¬”ä¸æ˜¯å¾ˆå¥½å•¦ï¼Œå¦‚æœå†™å¾—çƒ‚è¿˜è¯·è§è°…ã€‚å¦‚æœæ‚¨æƒ³å‘æœ¬ç«™æŠ•ç¨¿ï¼Œæ‚¨å¯é‚®ä»¶è”ç³» <Link
            href="mailto:hey@ohdragonboi.cn"
            class="text-foreground"
            underline
            external>hey@ohdragonboi.cn</Link
          > æ„Ÿè°¢æ”¯æŒï½
        </p>
        <br>
        <ContributionChart posts={allPosts} client:load />
      </div>
    </div>
  </section>
  <section class="flex flex-col gap-y-4">
    <h2 class="text-2xl font-medium">æœ€æ–°æ–‡ç« </h2>
    <ul class="flex flex-col gap-y-4">
      {
        blog.map((post) => (
          <li>
            <BlogCard entry={post} />
          </li>
        ))
      }
    </ul>
    <div class="flex justify-center">
      <Link
        href="/blog"
        class={buttonVariants({ variant: 'ghost' }) + ' group'}
      >
        æŸ¥çœ‹æ–‡ç« åˆ—è¡¨ <span
          class="ml-1.5 transition-transform group-hover:translate-x-1"
          >&rarr;</span
        >
      </Link>
    </div>
  </section>
  
  <section class="flex flex-col gap-y-4">
    <FriendsRSSFeed initialPosts={friendPosts} client:load />
    <div class="flex justify-center">
      <Link
        href="/friends"
        class={buttonVariants({ variant: 'ghost' }) + ' group'}
      >
        æŸ¥çœ‹å‹é“¾åˆ—è¡¨ <span
          class="ml-1.5 transition-transform group-hover:translate-x-1"
          >&rarr;</span
        >
      </Link>
    </div>
  </section>
</Layout>
